{% extends 'base.html' %}
{% block content %}
<h1>Piano Nutrizionale {{ patient['name'] }}</h1>
<form method="post">
<ul class="nav nav-tabs" id="dayTabs" role="tablist">
{% for day in days %}
<li class="nav-item" role="presentation">
  <button class="nav-link {% if loop.first %}active{% endif %}" data-bs-toggle="tab" data-bs-target="#tab{{loop.index}}" type="button">{{day}}</button>
</li>
{% endfor %}
</ul>
<div class="tab-content border p-3">
{% for day in days %}
<div class="tab-pane fade {% if loop.first %}show active{% endif %}" id="tab{{loop.index}}">
{% for meal in meals %}
<h5>{{ meal }}</h5>
<table class="table table-sm" id="tbl_{{day}}_{{meal}}">
<tr><th>Alimento</th><th>Gr</th><th>Kcal</th><th>CHO</th><th>PRO</th><th>FAT</th><th>Del</th></tr>
{% for row in plan[(day,meal)] %}
<tr>
<td><select name="food_{{row['id']}}" class="form-select food-select">
<option value="">--</option>
{% for food in foods %}
<option value="{{food['id']}}" data-kcal="{{food['kcal']}}" data-carbs="{{food['carbs']}}" data-protein="{{food['protein']}}" data-fat="{{food['fat']}}" {% if food['id']==row['food_id'] %}selected{% endif %}>{{food['name']}}</option>
{% endfor %}
</select></td>
<td><input name="gram_{{row['id']}}" type="number" class="form-control gram-input" value="{{row['grams']}}"></td>
<td class="kcal"></td>
<td class="carbs"></td>
<td class="protein"></td>
<td class="fat"></td>
<td><input type="checkbox" name="del_{{row['id']}}"></td>
</tr>
{% endfor %}
<tr class="new-row">
<td><select name="new_food_{{day}}_{{meal}}_1" class="form-select food-select">
<option value="">--</option>
{% for food in foods %}
<option value="{{food['id']}}" data-kcal="{{food['kcal']}}" data-carbs="{{food['carbs']}}" data-protein="{{food['protein']}}" data-fat="{{food['fat']}}">{{food['name']}}</option>
{% endfor %}
</select></td>
<td><input name="new_gram_{{day}}_{{meal}}_1" type="number" class="form-control gram-input"></td>
<td class="kcal"></td>
<td class="carbs"></td>
<td class="protein"></td>
<td class="fat"></td>
<td></td>
</tr>
</table>
<button class="btn btn-sm btn-secondary mb-3" type="button" onclick="addRow('{{day}}','{{meal}}')">Aggiungi riga</button>
{% endfor %}
</div>
{% endfor %}
</div>
<button class="btn btn-primary mt-2" type="submit">Salva</button>
<a class="btn btn-secondary mt-2" href="/patient/{{ patient['id'] }}">Torna</a>
</form>
<template id="foodOptions">
<option value="">--</option>
{% for food in foods %}
<option value="{{food['id']}}" data-kcal="{{food['kcal']}}" data-carbs="{{food['carbs']}}" data-protein="{{food['protein']}}" data-fat="{{food['fat']}}">{{food['name']}}</option>
{% endfor %}
</template>
<script>
function calcRow(row){
    const sel = row.querySelector('.food-select');
    const grams = parseFloat(row.querySelector('.gram-input').value) || 0;
    const opt = sel.options[sel.selectedIndex];
    const kcal = parseFloat(opt.dataset.kcal||0);
    const carbs = parseFloat(opt.dataset.carbs||0);
    const pro = parseFloat(opt.dataset.protein||0);
    const fat = parseFloat(opt.dataset.fat||0);
    row.querySelector('.kcal').textContent = ((kcal*grams)/100).toFixed(1);
    row.querySelector('.carbs').textContent = ((carbs*grams)/100).toFixed(1);
    row.querySelector('.protein').textContent = ((pro*grams)/100).toFixed(1);
    row.querySelector('.fat').textContent = ((fat*grams)/100).toFixed(1);
}
document.querySelectorAll('.food-select, .gram-input').forEach(el=>{
    el.addEventListener('change', e=>calcRow(e.target.closest('tr')));
    el.addEventListener('input', e=>calcRow(e.target.closest('tr')));
    calcRow(el.closest('tr'));
});
function addRow(day, meal){
    const table = document.getElementById(`tbl_${day}_${meal}`);
    const idx = table.querySelectorAll('tr.new-row').length + 1;
    const temp = document.createElement('tr');
    temp.className = 'new-row';
    temp.innerHTML = `<td><select name="new_food_${day}_${meal}_${idx}" class="form-select food-select">${document.getElementById('foodOptions').innerHTML}</select></td>`+
                     `<td><input name="new_gram_${day}_${meal}_${idx}" type="number" class="form-control gram-input"></td>`+
                     '<td class="kcal"></td><td class="carbs"></td><td class="protein"></td><td class="fat"></td><td></td>';
    table.appendChild(temp);
    temp.querySelectorAll('.food-select, .gram-input').forEach(el=>{
        el.addEventListener('change',()=>calcRow(temp));
        el.addEventListener('input',()=>calcRow(temp));
    });
}
</script>
{% endblock %}
