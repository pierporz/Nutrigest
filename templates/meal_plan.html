{% extends 'base.html' %}
{% block content %}
<h1>Piano Nutrizionale {{ patient['name'] }}</h1>
<form method="post">
<div class="row">
<div class="col-md-9">
<ul class="nav nav-tabs" id="dayTabs" role="tablist">
{% for day in days %}
<li class="nav-item" role="presentation">
  <button class="nav-link {% if loop.first %}active{% endif %}" data-bs-toggle="tab" data-bs-target="#tab{{loop.index}}" type="button">{{day}}</button>
</li>
{% endfor %}
</ul>
<div class="tab-content border p-3">
{% for day in days %}
<div class="tab-pane fade {% if loop.first %}show active{% endif %}" id="tab{{loop.index}}" data-day="{{day}}">
<div class="text-end mb-2 day-summary"></div>
{% for meal in meals %}
<h5>{{ meal }}</h5>
<table class="table table-sm" data-meal="{{meal}}">
<tr><th>Alimento</th><th>Gr</th><th>Kcal</th><th>CHO</th><th>PRO</th><th>FAT</th><th></th></tr>
{% for row in plan[(day,meal)] %}
<tr class="existing-row" data-kcal="{{ row['kcal'] }}" data-carbs="{{ row['carbs'] }}" data-protein="{{ row['protein'] }}" data-fat="{{ row['fat'] }}">
<td>{{ row['name'] }}</td>
<td>{{ row['grams'] }}</td>
<td>{{ row['kcal'] }}</td>
<td>{{ row['carbs'] }}</td>
<td>{{ row['protein'] }}</td>
<td>{{ row['fat'] }}</td>
<td>
  <a class="btn btn-sm btn-secondary" href="/patient/{{patient['id']}}/meal_plan/edit/{{row['id']}}">Modifica</a>
  <form method="post" action="/patient/{{patient['id']}}/meal_plan/delete/{{row['id']}}" style="display:inline">
    <button class="btn btn-sm btn-danger">Elimina</button>
  </form>
</td>
</tr>
{% endfor %}
<tr class="add-row">
<td>
  <input type="text" class="form-control form-control-sm food-search mb-1" placeholder="Filtra">
  <select name="food_{{day}}_{{meal}}[]" class="form-select">
  <option value="">--</option>
  {% for food in foods %}
  <option value="{{food['id']}}" data-kcal="{{food['kcal']}}" data-carbs="{{food['carbs']}}" data-protein="{{food['protein']}}" data-fat="{{food['fat']}}">{{food['name']}} ({{food['kcal']}}kcal C{{food['carbs']}} P{{food['protein']}} F{{food['fat']}})</option>
  {% endfor %}
  </select>
</td>
<td><input name="gram_{{day}}_{{meal}}[]" class="form-control"></td>
<td class="kcal"></td>
<td class="carbs"></td>
<td class="protein"></td>
<td class="fat"></td>
<td></td>
</tr>
<tr><td colspan="7"><button type="button" class="btn btn-sm btn-secondary" onclick="addRow(this)">Aggiungi riga</button></td></tr>
</table>
{% endfor %}
</div>
{% endfor %}
</div>
</div>
<div class="col-md-3">
  <div id="goal-summary" class="border p-2 mb-2"></div>
  <div id="meal-breakdown" class="border p-2"></div>
</div>
</div>
<button class="btn btn-primary mt-2" type="submit">Salva</button>
<a class="btn btn-secondary mt-2" href="/patient/{{ patient['id'] }}">Torna</a>
</form>
<script>
const goals = {{ goals|tojson }};
function addRow(btn) {
  const table = btn.closest('table');
  const row = table.querySelector('tr.add-row');
  const clone = row.cloneNode(true);
  clone.querySelectorAll('input').forEach(i => i.value = '');
  clone.querySelector('select').selectedIndex = 0;
  table.insertBefore(clone, btn.closest('tr'));
  setupFilter(clone);
  updateMacros(clone);
}
function updateMacros(row) {
  const sel = row.querySelector('select');
  const grams = parseFloat(row.querySelector('input').value) || 0;
  const opt = sel.options[sel.selectedIndex];
  const kcal = parseFloat(opt.dataset.kcal || 0) * grams / 100;
  const carbs = parseFloat(opt.dataset.carbs || 0) * grams / 100;
  const pro = parseFloat(opt.dataset.protein || 0) * grams / 100;
  const fat = parseFloat(opt.dataset.fat || 0) * grams / 100;
  row.querySelector('.kcal').textContent = kcal ? kcal.toFixed(1) : '';
  row.querySelector('.carbs').textContent = carbs ? carbs.toFixed(1) : '';
  row.querySelector('.protein').textContent = pro ? pro.toFixed(1) : '';
  row.querySelector('.fat').textContent = fat ? fat.toFixed(1) : '';
  computeTotals();
}
document.addEventListener('input', e => {
  if (e.target.matches('tr.add-row input')) {
    updateMacros(e.target.closest('tr'));
  }
});
document.addEventListener('change', e => {
  if (e.target.matches('tr.add-row select')) {
    updateMacros(e.target.closest('tr'));
  }
});
function setupFilter(row) {
  const inp = row.querySelector('.food-search');
  if (!inp) return;
  const sel = row.querySelector('select');
  inp.addEventListener('input', () => {
    const f = inp.value.toLowerCase();
    for (const opt of sel.options) {
      opt.style.display = opt.text.toLowerCase().includes(f) ? '' : 'none';
    }
  });
}
function computeTotals() {
  document.querySelectorAll('.tab-pane').forEach(pane => {
    let dayTot = {kcal:0,carbs:0,protein:0,fat:0};
    let mealData = {};
    pane.querySelectorAll('table').forEach(table => {
      let mealTot = {kcal:0,carbs:0,protein:0,fat:0};
      table.querySelectorAll('tr').forEach(row => {
        if (row.querySelector('th')) return;
        let kcal=0,carbs=0,protein=0,fat=0;
        if (row.classList.contains('add-row')) {
          kcal = parseFloat(row.querySelector('.kcal').textContent)||0;
          carbs = parseFloat(row.querySelector('.carbs').textContent)||0;
          protein = parseFloat(row.querySelector('.protein').textContent)||0;
          fat = parseFloat(row.querySelector('.fat').textContent)||0;
        } else {
          kcal = parseFloat(row.dataset.kcal)||0;
          carbs = parseFloat(row.dataset.carbs)||0;
          protein = parseFloat(row.dataset.protein)||0;
          fat = parseFloat(row.dataset.fat)||0;
        }
        mealTot.kcal += kcal;
        mealTot.carbs += carbs;
        mealTot.protein += protein;
        mealTot.fat += fat;
      });
      dayTot.kcal += mealTot.kcal;
      dayTot.carbs += mealTot.carbs;
      dayTot.protein += mealTot.protein;
      dayTot.fat += mealTot.fat;
      mealData[table.dataset.meal] = mealTot;
    });
    const dsum = pane.querySelector('.day-summary');
    if (dsum) {
      dsum.textContent = `Totale giorno: ${Math.round(dayTot.kcal)} kcal CHO ${Math.round(dayTot.carbs)}g PRO ${Math.round(dayTot.protein)}g FAT ${Math.round(dayTot.fat)}g`;
    }
    pane.dataset.dayTotals = JSON.stringify(dayTot);
    pane.dataset.mealTotals = JSON.stringify(mealData);
  });
  const active = document.querySelector('.tab-pane.active');
  if (active) {
    const dayTot = JSON.parse(active.dataset.dayTotals || '{}');
    const mealTotals = JSON.parse(active.dataset.mealTotals || '{}');
    const bars = ['calories','cho_g','pro_g','fat_g'].map(g=>{
      const key = g==='calories' ? 'kcal' : g==='cho_g' ? 'carbs' : g==='pro_g' ? 'protein' : 'fat';
      const val = dayTot[key] || 0;
      const goal = goals[g];
      const lbl = g==='calories'?'Kcal':g==='cho_g'?'CHO':g==='pro_g'?'PRO':'FAT';
      const pct = goal?Math.min(100,val/goal*100):0;
      return `<div class="mb-1"><small>${lbl}: ${Math.round(val)} / ${Math.round(goal)}</small><div class="progress"><div class="progress-bar" style="width:${pct}%"></div></div></div>`;
    }).join('');
    const mealHtml = Object.keys(mealTotals).map(m=>{
      const t = mealTotals[m];
      const pct = k=> dayTot[k] ? Math.round(t[k]/dayTot[k]*100) : 0;
      return `<div><b>${m}</b>: Kcal ${pct('kcal')}% CHO ${pct('carbs')}% PRO ${pct('protein')}% FAT ${pct('fat')}%</div>`;
    }).join('');
    document.getElementById('goal-summary').innerHTML =
      `<div><b>Obiettivi:</b> ${Math.round(goals.calories)} kcal CHO ${Math.round(goals.cho_g)}g PRO ${Math.round(goals.pro_g)}g FAT ${Math.round(goals.fat_g)}g</div>`+
      `<div>Totale giorno: ${Math.round(dayTot.kcal)} kcal CHO ${Math.round(dayTot.carbs)}g PRO ${Math.round(dayTot.protein)}g FAT ${Math.round(dayTot.fat)}g</div>`+
      bars;
    document.getElementById('meal-breakdown').innerHTML = mealHtml;
  }
}
document.querySelectorAll('tr.add-row').forEach(setupFilter);
computeTotals();
document.getElementById('dayTabs').addEventListener('shown.bs.tab', computeTotals);
</script>
{% endblock %}
